%h1 Listing Products to Sell

= form_tag("/product_to_sells", :method => :get) do
  .form-inline
    .field
      .float-left
        %div
          = label_tag :category
          = select_tag :category, options_for_select(@categories, :selected => params[:category]), :include_blank => true, :class => "form-control"
          .checkboxes
            - if params[:listed]
              = check_box_tag :listed, 1, :checked => true
            - else
              = check_box_tag :listed, 1
            = label_tag :listed
            - if params[:unlisted]
              = check_box_tag :unlisted, 1, :checked => true
            - else
              = check_box_tag :unlisted, 1
            = label_tag :unlisted
            - if params[:sales_rank]
              = check_box_tag :sales_rank, 1, :checked => true
            - else
              = check_box_tag :sales_rank, 1
            = label_tag :sales_rank
          - if params[:manufacture]
            = hidden_tag :manufacturer, params[:manufacturer]
      .float-left
        = label_tag :low_price
        = text_field_tag :low_price, params[:low_price], class: "form-control"
        = label_tag :high_price
        = text_field_tag :high_price, params[:high_price], class: "form-control"
      .float-left
        = submit_tag "Search", :class => "btn btn-default"
        = link_to 'New Product', new_product_path, :class => "btn btn-default"
      .clear
      .float-right= paginate @product_to_sells

%table.table.table-condensed.table-striped.products
  %tr
    %th Category
    %th Manufacturer
    %th Product
    %th Images
    %th Price
    %th
      Cost/
      %br
        Shipping Cost
    %th.col-sm-1 Profit
    %th.col-sm-1 Ebay
    %th Category ID
    %th Listed
    %th
    %th

  - @product_to_sells.each do |p|
    %tr
      %td= @products_hash[p.product_id].category
      %td
        - if @products_hash[p.product_id].manufacturer
          = link_to @products_hash[p.product_id].manufacturer, "/product_to_sells/manufacturers/#{@products_hash[p.product_id].manufacturer}"
      %td= link_to @products_hash[p.product_id].title, product_path(@products_hash[p.product_id])
      %td
        = link_to image_tag(@products_hash[p.product_id].image_url1.sub(/.jpg$/, "._SL75_.jpg")), @products_hash[p.product_id].image_url1, "data-lightbox" => @products_hash[p.product_id].image_url1 rescue nil
        = link_to image_tag(@products_hash[p.product_id].image_url2.sub(/.jpg$/, "._SL75_.jpg")), @products_hash[p.product_id].image_url2, "data-lightbox" => @products_hash[p.product_id].image_url2 rescue nil
        = link_to image_tag(@products_hash[p.product_id].image_url3.sub(/.jpg$/, "._SL75_.jpg")), @products_hash[p.product_id].image_url3, "data-lightbox" => @products_hash[p.product_id].image_url3 rescue nil
        = link_to image_tag(@products_hash[p.product_id].image_url4.sub(/.jpg$/, "._SL75_.jpg")), @products_hash[p.product_id].image_url4, "data-lightbox" => @products_hash[p.product_id].image_url4 rescue nil
        = link_to image_tag(@products_hash[p.product_id].image_url5.sub(/.jpg$/, "._SL75_.jpg")), @products_hash[p.product_id].image_url5, "data-lightbox" => @products_hash[p.product_id].image_url5 rescue nil
      %td
        - if @products_hash[p.product_id].price
          - case @products_hash[p.product_id].currency
          - when "USD"
            = link_to number_to_currency(@products_hash[p.product_id].price, :locale => :en), @products_hash[p.product_id].url
      %td
        - if @products_hash[p.product_id].cost
          %p= link_to number_to_currency(@products_hash[p.product_id].cost), @products_hash[p.product_id].url_jp
        - else
          .center
            %p -
        %p= number_to_currency @products_hash[p.product_id].shipping_cost
      %td
        - if @products_hash[p.product_id].profit && @products_hash[p.product_id].cost
          %p
            [amazon]
            %br
            - if @products_hash[p.product_id].profit/@products_hash[p.product_id].cost.to_f > 0.1
              %span.green
                = number_to_currency @products_hash[p.product_id].profit
                %br
                = "(#{(100*@products_hash[p.product_id].profit/@products_hash[p.product_id].cost).round(0)}%)"
            - elsif @products_hash[p.product_id].profit < 0
              %span.red
                = number_to_currency @products_hash[p.product_id].profit
            - else
              = number_to_currency @products_hash[p.product_id].profit
              %br
              = "(#{(100*@products_hash[p.product_id].profit/@products_hash[p.product_id].cost).round(0)}%)"
        - unless @sold_items[@products_hash[p.product_id].id].blank?
          %p
            [ebay]
            %br
            - if @products_hash[p.product_id].cost
              - if ((@sold_items[@products_hash[p.product_id].id].inject{ |sum, el| sum + el }.to_f / @sold_items[@products_hash[p.product_id].id].size).round(2)*@exchange_rate - @products_hash[p.product_id].cost)/@products_hash[p.product_id].cost.to_f > 0.1
                %span.green
                  = number_to_currency (@sold_items[@products_hash[p.product_id].id].inject{ |sum, el| sum + el }.to_f / @sold_items[@products_hash[p.product_id].id].size).round(2)*@exchange_rate - @products_hash[p.product_id].cost
                  %br
                  = "(#{(100*((@sold_items[@products_hash[p.product_id].id].inject{ |sum, el| sum + el }.to_f / @sold_items[@products_hash[p.product_id].id].size).round(2)*@exchange_rate - @products_hash[p.product_id].cost)/@products_hash[p.product_id].cost).round(0)}%)"
              - elsif (@sold_items[@products_hash[p.product_id].id].inject{ |sum, el| sum + el }.to_f / @sold_items[@products_hash[p.product_id].id].size).round(2)*@exchange_rate - @products_hash[p.product_id].cost < 0
                %span.red
                  = number_to_currency (@sold_items[@products_hash[p.product_id].id].inject{ |sum, el| sum + el }.to_f / @sold_items[@products_hash[p.product_id].id].size).round(2)*@exchange_rate - @products_hash[p.product_id].cost
              - else
                = number_to_currency (@sold_items[@products_hash[p.product_id].id].inject{ |sum, el| sum + el }.to_f / @sold_items[@products_hash[p.product_id].id].size).round(2)*@exchange_rate - @products_hash[p.product_id].cost
                %br
                = "(#{(100*((@sold_items[@products_hash[p.product_id].id].inject{ |sum, el| sum + el }.to_f / @sold_items[@products_hash[p.product_id].id].size).round(2)*@exchange_rate - @products_hash[p.product_id].cost)/@products_hash[p.product_id].cost).round(0)}%)"

          -# - if @products_hash[p.product_id].profit/(@products_hash[p.product_id].price*@exchange_rate.to_f) > 0.1
          -#   %span.green
          -# - elsif @products_hash[p.product_id].profit < 0
          -#   %span.red
          -# = number_to_currency @products_hash[p.product_id].profit
      %td
        - unless @ebay_items[@products_hash[p.product_id].id].blank?
          %p
            = t("views.product.all_count")
            = number_with_delimiter @ebay_items[@products_hash[p.product_id].id].count
            - if @ebay_items[@products_hash[p.product_id].id].count > 0
              %br
              = t("views.product.sold_count")
              = number_with_delimiter @sold_items[@products_hash[p.product_id].id].count
              - if @sold_items[@products_hash[p.product_id].id].count > 0
                %p
                  = t("views.product.highest")
                  %br
                  = "#{@locale} #{@sold_items[@products_hash[p.product_id].id].last}"
                  %br
                  = t("views.product.average")
                  %br
                  = "#{@locale} #{(@sold_items[@products_hash[p.product_id].id].inject{ |sum, el| sum + el }.to_f / @sold_items[@products_hash[p.product_id].id].size).round(1)}"
      %td= p.category_id
      %td
        - if p.listed
          = "Listed"
      %td
        = link_to 'Show', product_to_sell_path(p), class: "btn btn-default"
        = link_to 'Edit', edit_product_to_sell_path(p), class: "btn btn-default"
        = link_to 'Sold', "#{new_order_path}/#{p.product_id}", class: "btn btn-info"
        = link_to 'Destroy', p, :method => :delete, :data => { :confirm => 'Are you sure?' }, class: "btn btn-danger"

.float-right= paginate @product_to_sells

= link_to 'New Product to sell', new_product_to_sell_path, class: "btn btn-default"
